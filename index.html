<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>NetwortsML ‚Äì Pagos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#020617">
  <link rel="icon" href="icon-192.png" />

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      min-height: 100vh;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #e5e7eb;
      background:
        radial-gradient(circle at top left, #22c55e22, transparent 55%),
        radial-gradient(circle at bottom right, #0ea5e922, transparent 55%),
        #020617;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    .app-shell {
      width: 100%;
      max-width: 900px;
      background: rgba(15,23,42,0.95);
      border-radius: 24px;
      border: 1px solid rgba(148,163,184,0.35);
      box-shadow:
        0 24px 60px rgba(15,23,42,0.9),
        0 0 0 1px rgba(15,23,42,1);
      overflow: hidden;
      backdrop-filter: blur(18px);
    }

    .app-header {
      padding: 18px 22px;
      border-bottom: 1px solid rgba(30,64,175,0.45);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      background: linear-gradient(135deg, #020617 0%, #0f172a 45%, #06141f 100%);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-logo {
      width: 42px;
      height: 42px;
      border-radius: 16px;
      background: radial-gradient(circle at 30% 20%, #a7f3d0 0, #22c55e 40%, #16a34a 70%, #052e16 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 0 2px rgba(15,23,42,0.9);
      font-size: 20px;
    }

    .brand-title {
      display: flex;
      flex-direction: column;
    }

    .brand-title span:nth-child(1) {
      font-size: 15px;
      font-weight: 600;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      color: #a5b4fc;
    }

    .brand-title span:nth-child(2) {
      font-size: 13px;
      color: #9ca3af;
    }

    .header-pill {
      font-size: 11px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(74,222,128,0.45);
      background: radial-gradient(circle at top left, #bbf7d022, transparent 65%);
      color: #bbf7d0;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }

    .header-pill span.icon {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: #22c55e;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      color: #022c22;
    }

    .app-body {
      padding: 20px 22px 22px;
      display: grid;
      grid-template-columns: minmax(0, 3fr) minmax(0, 2.4fr);
      gap: 18px;
    }

    .hero {
      display: flex;
      flex-direction: column;
      gap: 14px;
      justify-content: center;
    }

    .hero-title {
      font-size: clamp(20px, 3.1vw, 28px);
      font-weight: 700;
      letter-spacing: 0.02em;
    }

    .hero-title span {
      color: #22c55e;
    }

    .hero-subtitle {
      font-size: 13px;
      color: #9ca3af;
      max-width: 360px;
      line-height: 1.5;
    }

    .hero-slogan {
      font-size: 12px;
      color: #fcd34d;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(30,64,175,0.25);
      border: 1px solid rgba(129,140,248,0.45);
      width: fit-content;
    }

    .hero-slogan span.icon {
      font-size: 14px;
    }

    .hero-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 4px;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 7px 14px;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: transform 0.08s ease, box-shadow 0.12s ease, background 0.12s ease;
      white-space: nowrap;
    }

    .btn-primary {
      background: linear-gradient(135deg, #22c55e, #16a34a);
      color: #022c22;
      font-weight: 600;
      box-shadow: 0 8px 20px rgba(22,163,74,0.45);
    }

    .btn-primary span.icon {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: rgba(6,95,70,0.15);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 13px;
    }

    .btn-secondary {
      background: rgba(15,23,42,0.9);
      color: #e5e7eb;
      border: 1px solid rgba(75,85,99,0.9);
    }

    .btn-danger {
      background: #dc2626;
      color: #fee2e2;
    }

    .btn-sm {
      padding: 4px 8px;
      font-size: 11px;
      border-radius: 999px;
    }

    .btn:active {
      transform: translateY(1px) scale(0.98);
      box-shadow: none;
    }

    .hero-meta {
      margin-top: 8px;
      font-size: 11px;
      color: #6b7280;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .hero-meta span {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .hero-meta span.dot {
      width: 4px;
      height: 4px;
      border-radius: 50%;
      background: #4b5563;
    }

    .panel {
      background: radial-gradient(circle at top left, rgba(148,163,184,0.08), transparent 60%);
      border-radius: 18px;
      border: 1px solid rgba(31,41,55,0.9);
      padding: 14px 14px 12px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 4px;
    }

    .panel-header-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: #9ca3af;
    }

    .panel-chip {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(37,99,235,0.6);
      color: #bfdbfe;
    }

    .panel-body {
      font-size: 12px;
      color: #9ca3af;
      line-height: 1.5;
    }

    .steps {
      margin-top: 6px;
      display: grid;
      gap: 6px;
      font-size: 11px;
    }

    .step {
      display: flex;
      align-items: flex-start;
      gap: 8px;
    }

    .step-badge {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      background: rgba(15,23,42,0.95);
      border: 1px solid rgba(55,65,81,0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: #9ca3af;
      flex-shrink: 0;
    }

    .step-text b {
      color: #e5e7eb;
    }

    .status-pill {
      margin-top: 8px;
      font-size: 11px;
      padding: 6px 9px;
      border-radius: 10px;
      background: rgba(6,78,59,0.65);
      color: #bbf7d0;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .status-pill span.dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34,197,94,0.25);
    }

    @media (max-width: 720px) {
      .app-shell {
        border-radius: 20px;
      }
      .app-body {
        grid-template-columns: minmax(0, 1fr);
        padding: 16px 16px 18px;
      }
      .app-header {
        flex-direction: column;
        align-items: flex-start;
      }
    }

    /* ===== ESTILOS DEL PANEL REAL (TU SISTEMA) ===== */

    #panel-clientes {
      display: none;
      width: 100%;
      min-height: 100vh;
      background: #0f172a;
      color: #e5e7eb;
      font-family: Arial, sans-serif;
    }

    #panel-clientes header {
      background: #111827;
      padding: 12px 16px;
      text-align: center;
      border-bottom: 1px solid #1f2937;
    }

    #panel-clientes header h1 {
      margin: 0;
      font-size: 18px;
    }

    #panel-clientes header small {
      display: block;
      font-size: 11px;
      color: #9ca3af;
    }

    #panel-clientes main {
      padding: 12px;
      max-width: 1100px;
      margin: 0 auto;
    }

    .card {
      background: #111827;
      border: 1px solid #1f2937;
      border-radius: 10px;
      padding: 10px 12px;
      margin-bottom: 14px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }

    .card h2 {
      margin-top: 0;
      font-size: 15px;
      margin-bottom: 8px;
    }

    label {
      display: block;
      font-size: 12px;
      margin-top: 6px;
      margin-bottom: 2px;
    }

    input, select, textarea {
      width: 100%;
      padding: 6px 8px;
      font-size: 13px;
      border-radius: 6px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      box-sizing: border-box;
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #22c55e;
    }

    textarea {
      resize: vertical;
      min-height: 40px;
    }

    .row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .col-2 {
      flex: 1 1 50%;
    }

    .col-3 {
      flex: 1 1 33%;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    th, td {
      border-bottom: 1px solid #1f2937;
      padding: 6px 4px;
      text-align: left;
    }

    th {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      color: #9ca3af;
      white-space: nowrap;
    }

    .small {
      font-size: 11px;
      color: #9ca3af;
    }

    .scroll-x {
      overflow-x: auto;
    }

    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 10px;
      font-weight: bold;
    }

    .badge-ok { background: #064e3b; color: #a7f3d0; }
    .badge-pendiente { background: #7f1d1d; color: #fecaca; }
    .badge-gracia { background: #78350f; color: #fed7aa; }

    @media (max-width: 600px) {
      .hide-mobile { display: none; }
    }
  </style>
</head>
<body>
  <!-- SHELL BONITO -->
  <div class="app-shell">
    <header class="app-header">
      <div class="brand">
        <div class="brand-logo">‚ö°</div>
        <div class="brand-title">
          <span>NetwortsML ‚Äì Pagos</span>
          <span>Sistema pro de control de mensualidades</span>
        </div>
      </div>
      <div class="header-pill">
        <span class="icon">‚úì</span>
        Instalable como app (PWA)
      </div>
    </header>

    <main class="app-body">
      <section class="hero">
        <div class="hero-slogan">
          <span class="icon">üì∂</span>
          SIN WIFI üî• NO HAY PARA√çSO üî•
        </div>

        <h1 class="hero-title">
          Controla tus <span>clientes y pagos</span> como si fuera un panel profesional.
        </h1>

        <p class="hero-subtitle">
          Esta es la versi√≥n app de tu sistema. Desde aqu√≠ podr√°s abrir tu panel de mensualidades,
          ver qui√©n est√° al d√≠a, en gracia o para corte, y llevar un historial por meses.
        </p>

        <div class="hero-actions">
          <button class="btn btn-primary" id="btn-abrir-panel">
            <span class="icon">‚ñ∂</span>
            Abrir panel de clientes
          </button>
          <button class="btn btn-secondary" disabled>
            Exportar respaldo (pr√≥ximamente)
          </button>
        </div>

        <div class="hero-meta">
          <span>üíæ Datos locales en tu celular</span>
          <span class="dot"></span>
          <span>üì≤ Dise√±ado para uso diario</span>
        </div>
      </section>

      <aside class="panel">
        <div class="panel-header">
          <span class="panel-header-title">estado de la app</span>
          <span class="panel-chip">Versi√≥n 1.0 ‚Ä¢ Activa</span>
        </div>
        <div class="panel-body">
          <p>
            Ya tienes lista la base de la app con tu panel de clientes integrado.
            Puedes usarla como app instalada y todo se guarda en este dispositivo.
          </p>

          <div class="steps">
            <div class="step">
              <div class="step-badge">1</div>
              <div class="step-text">
                <b>Abre el panel de clientes</b> para registrar usuarios de tu internet.
              </div>
            </div>
            <div class="step">
              <div class="step-badge">2</div>
              <div class="step-text">
                <b>Marca pagos, atrasos y cortes</b> con un tap desde tu cel.
              </div>
            </div>
            <div class="step">
              <div class="step-badge">3</div>
              <div class="step-text">
                Usa el historial anual para ver qui√©n ha pagado mes a mes.
              </div>
            </div>
          </div>

          <div class="status-pill">
            <span class="dot"></span>
            Pr√≥ximo nivel: exportar respaldos y sincronizar con tu VPS.
          </div>
        </div>
      </aside>
    </main>
  </div>

  <!-- PANEL REAL DE TU SISTEMA -->
  <div id="panel-clientes">
    <header>
      <h1>Sistema de Mensualidades Internet</h1>
      <small>SIN WIFI üî• NO HAY PARA√çSO üî•</small>
    </header>

    <main>
      <!-- FORMULARIO -->
      <div class="card">
        <h2 id="form-title">Registrar cliente</h2>

        <form id="cliente-form">
          <input type="hidden" id="cliente-id">

          <div class="row">
            <div class="col-2">
              <label>Nombre</label>
              <input id="nombre" required>
            </div>

            <div class="col-2">
              <label>Tel√©fono</label>
              <input id="telefono">
            </div>
          </div>

          <label>Direcci√≥n</label>
          <input id="direccion">

          <div class="row">
            <div class="col-3">
              <label>Plan</label>
              <input id="plan">
            </div>

            <div class="col-3">
              <label>Monto</label>
              <input id="monto" type="number">
            </div>

            <div class="col-3">
              <label>D√≠a pago</label>
              <input id="dia-pago" type="number" min="1" max="31" placeholder="1 - 31" />
            </div>
          </div>

          <label>D√≠as de gracia</label>
          <input id="corte-dias" type="number">

          <label>Notas</label>
          <textarea id="notas"></textarea>

          <button class="btn btn-primary" type="submit">Guardar</button>
        </form>
      </div>

      <!-- TABLA -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <h2>Clientes registrados</h2>
          <input id="buscador" placeholder="Buscar...">
        </div>

        <div class="scroll-x">
          <table>
            <thead>
              <tr>
                <th>Cliente</th>
                <th>Plan</th>
                <th class="hide-mobile">Monto</th>
                <th class="hide-mobile">Direcci√≥n</th>
                <th>D√≠a pago</th>
                <th>Corte</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>

            <tbody id="tabla-clientes"></tbody>
          </table>
        </div>
      </div>

      <!-- REPORTE -->
      <div class="card">
        <h2>Historial anual</h2>
        <select id="reporte-anio" style="margin-bottom:6px;"></select>

        <div class="scroll-x">
          <table>
            <thead><tr id="reporte-header"></tr></thead>
            <tbody id="reporte-body"></tbody>
          </table>
        </div>
      </div>
    </main>

    <!-- MODAL MULTIANUAL -->
    <div id="modal-meses" 
        style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.65);backdrop-filter:blur(3px);z-index:9999;justify-content:center;align-items:center;">
      <div style="background:#111827;padding:20px;border-radius:12px;width:90%;max-width:420px;">
        <h2 style="margin-top:0;font-size:18px;text-align:center;">
          Editar meses ‚Äî <span id="modal-nombre"></span>
        </h2>

        <div style="text-align:center;margin-bottom:10px;">
          <label style="font-size:12px;color:#9ca3af;">A√±o:</label>
          <select id="modal-anio"
                  onchange="abrirModalMeses(clienteEditandoMeses)"
                  style="background:#0f172a;color:#e5e7eb;border-radius:6px;border:1px solid #4b5563;padding:4px 8px;">
          </select>
        </div>

        <p style="font-size:12px;color:#9ca3af;text-align:center;margin-top:-4px;">
          Toca para marcar ‚úî pagado o ‚úñ pendiente
        </p>

        <div id="lista-meses"></div>

        <div style="text-align:right;margin-top:12px;">
          <button type="button" onclick="cerrarModalMeses()" class="btn btn-secondary">
            Cerrar
          </button>
          <button type="button" onclick="guardarCambiosHistorial()" class="btn btn-primary">
            Guardar
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Bot√≥n para cambiar de la pantalla bonita al panel real
    document.getElementById('btn-abrir-panel').addEventListener('click', () => {
      document.querySelector('.app-shell').style.display = "none";
      document.getElementById('panel-clientes').style.display = "block";
    });

    // ======== TU L√ìGICA COMPLETA DEL SISTEMA ========

    const STORAGE_KEY = "mensualidades_clientes_v2";
    const MESES_CORTOS = ["Ene","Feb","Mar","Abr","May","Jun","Jul","Ago","Sep","Oct","Nov","Dic"];

    function cargarClientes() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return [];
      try {
        const arr = JSON.parse(raw);
        return arr.map(c => ({ historialPagos: {}, ...c, historialPagos: c.historialPagos || {} }));
      } catch {
        return [];
      }
    }

    function guardarClientes(lista) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(lista));
    }

    function obtenerMesActualKey() {
      const hoy = new Date();
      return hoy.getFullYear() + "-" + String(hoy.getMonth()+1).padStart(2,"0");
    }

    /* ESTADO CLIENTE */
    function calcularEstadoCliente(c) {
      const hoy = new Date();
      const a√±o = hoy.getFullYear();
      const mesActual = hoy.getMonth();
      const mesKey = obtenerMesActualKey();

      if (c.historialPagos[mesKey]) {
        return { tipo:"ok", etiqueta:"PAGADO", diasAtraso:0 };
      }

      let diasAtraso = 0;
      if (c.diaPago) {
        const fechaPago = new Date(a√±o, mesActual, c.diaPago);
        if (hoy > fechaPago) {
          diasAtraso = Math.floor((hoy - fechaPago)/(1000*60*60*24));
        }
      }

      const corte = c.corteDias != null ? Number(c.corteDias) : 5;

      if (diasAtraso > 0 && diasAtraso <= corte) {
        return { tipo:"gracia", etiqueta:`EN GRACIA (${diasAtraso})`, diasAtraso };
      }

      if (diasAtraso > corte) {
        return { tipo:"pendiente", etiqueta:`PENDIENTE (${diasAtraso})`, diasAtraso };
      }

      return { tipo:"pendiente", etiqueta:"PENDIENTE", diasAtraso };
    }

    function obtenerClaseBadge(e) {
      if (e.tipo === "ok") return "badge badge-ok";
      if (e.tipo === "gracia") return "badge badge-gracia";
      return "badge badge-pendiente";
    }

    /* TABLA PRINCIPAL */
    function renderTablaClientes(filtro="") {
      const tbody = document.getElementById("tabla-clientes");
      if (!tbody) return;
      tbody.innerHTML = "";

      let clientes = cargarClientes();

      if (filtro.trim() !== "") {
        const f = filtro.toLowerCase();
        clientes = clientes.filter(c =>
          (c.nombre||"").toLowerCase().includes(f) ||
          (c.direccion||"").toLowerCase().includes(f) ||
          (c.plan||"").toLowerCase().includes(f)
        );
      }

      if (clientes.length===0) {
        tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;color:#9ca3af;">Sin clientes</td></tr>`;
        return;
      }

      clientes.sort((a,b)=> (a.nombre||"").localeCompare(b.nombre||"","es"));
      const mesKey = obtenerMesActualKey();

      for (const c of clientes) {
        const tr = document.createElement("tr");
        const estado = calcularEstadoCliente(c);

        const tdNombre = document.createElement("td");
        tdNombre.innerHTML = `<strong>${c.nombre}</strong><br><span class="small">${c.telefono||""}</span>`;

        const tdPlan = document.createElement("td");
        tdPlan.textContent = c.plan||"";

        const tdMonto = document.createElement("td");
        tdMonto.textContent = c.monto ? "$"+c.monto : "-";
        tdMonto.classList.add("hide-mobile");

        const tdDireccion = document.createElement("td");
        tdDireccion.textContent = c.direccion||"";
        tdDireccion.classList.add("hide-mobile");

        const tdDiaPago = document.createElement("td");
        tdDiaPago.textContent = c.diaPago||"-";

        const tdCorte = document.createElement("td");
        tdCorte.textContent = c.corteDias||"-";

        const tdEstado = document.createElement("td");
        tdEstado.innerHTML = `<span class="${obtenerClaseBadge(estado)}">${estado.etiqueta}</span>`;

        const tdAcc = document.createElement("td");

        const btnPay = document.createElement("button");
        btnPay.className = "btn btn-sm btn-primary";
        btnPay.textContent = c.historialPagos[mesKey] ? "Pendiente" : "Pagado";
        btnPay.onclick = () => marcarPagadoMesActual(c.id);

        const btnEdit = document.createElement("button");
        btnEdit.className = "btn btn-sm btn-secondary";
        btnEdit.style.marginLeft="4px";
        btnEdit.textContent = "Editar";
        btnEdit.onclick = () => cargarClienteEnFormulario(c.id);

        const btnMeses = document.createElement("button");
        btnMeses.className = "btn btn-sm btn-secondary";
        btnMeses.style.marginLeft="4px";
        btnMeses.textContent = "Meses";
        btnMeses.onclick = () => abrirModalMeses(c.id);

        const btnDel = document.createElement("button");
        btnDel.className = "btn btn-sm btn-danger";
        btnDel.style.marginLeft="4px";
        btnDel.textContent = "Borrar";
        btnDel.onclick = () => borrarCliente(c.id);

        tdAcc.appendChild(btnPay);
        tdAcc.appendChild(btnEdit);
        tdAcc.appendChild(btnMeses);
        tdAcc.appendChild(btnDel);

        tr.appendChild(tdNombre);
        tr.appendChild(tdPlan);
        tr.appendChild(tdMonto);
        tr.appendChild(tdDireccion);
        tr.appendChild(tdDiaPago);
        tr.appendChild(tdCorte);
        tr.appendChild(tdEstado);
        tr.appendChild(tdAcc);

        tbody.appendChild(tr);
      }

      renderReporteAnual();
    }

    /* REPORTE ANUAL */
    function obtenerAniosDeHistorial(clientes) {
      const a√±os = new Set([new Date().getFullYear()]);
      for (const c of clientes) {
        if (c.historialPagos) {
          for (const k of Object.keys(c.historialPagos)) {
            const a√±o = Number(k.split("-")[0]);
            if (!isNaN(a√±o)) a√±os.add(a√±o);
          }
        }
      }
      return [...a√±os].sort();
    }

    function renderOpcionesAnios() {
      const clientes = cargarClientes();
      const a√±os = obtenerAniosDeHistorial(clientes);
      const select = document.getElementById("reporte-anio");
      const actual = new Date().getFullYear();
      if (!select) return;

      select.innerHTML = "";
      a√±os.forEach(a=>{
        const o = document.createElement("option");
        o.value=a;
        o.textContent=a;
        if (a===actual) o.selected=true;
        select.appendChild(o);
      });
    }

    function renderReporteAnual() {
      const select = document.getElementById("reporte-anio");
      const th = document.getElementById("reporte-header");
      const tb = document.getElementById("reporte-body");
      if (!select || !th || !tb) return;

      renderOpcionesAnios();

      const clientes = cargarClientes();
      const a√±o = Number(select.value);

      th.innerHTML="";
      tb.innerHTML="";

      let h = `<th>Cliente</th>`;
      MESES_CORTOS.forEach(m=> h+=`<th>${m}</th>`);
      th.innerHTML = h;

      clientes.sort((a,b)=> (a.nombre||"").localeCompare(b.nombre||"","es"));

      for (const c of clientes) {
        let fila = `<td><strong>${c.nombre}</strong></td>`;
        for (let i=1;i<=12;i++) {
          const key = `${a√±o}-${String(i).padStart(2,"0")}`;
          fila += `<td style="text-align:center;color:${c.historialPagos[key]?'#22c55e':'#fca5a5'};">
                    ${c.historialPagos[key]?'‚úî':'‚úñ'}
                   </td>`;
        }
        tb.innerHTML += `<tr>${fila}</tr>`;
      }
    }

    /* PAGO MES ACTUAL */
    function marcarPagadoMesActual(id) {
      let clientes = cargarClientes();
      const i = clientes.findIndex(c=>c.id===id);
      if (i===-1) return;

      const key = obtenerMesActualKey();
      clientes[i].historialPagos[key] = !clientes[i].historialPagos[key];

      guardarClientes(clientes);
      const buscador = document.getElementById("buscador");
      renderTablaClientes(buscador ? buscador.value : "");
    }

    /* EDITAR CLIENTE */
    function cargarClienteEnFormulario(id) {
      const clientes = cargarClientes();
      const c = clientes.find(x=>x.id===id);
      if (!c) return;

      document.getElementById("cliente-id").value = c.id;
      document.getElementById("nombre").value = c.nombre;
      document.getElementById("telefono").value = c.telefono||"";
      document.getElementById("direccion").value = c.direccion||"";
      document.getElementById("plan").value = c.plan||"";
      document.getElementById("monto").value = c.monto||"";
      document.getElementById("dia-pago").value = c.diaPago||"";
      document.getElementById("corte-dias").value = c.corteDias||"";
      document.getElementById("notas").value = c.notas||"";

      document.getElementById("form-title").textContent = "Editar cliente";
    }

    const form = document.getElementById("cliente-form");
    if (form) {
      form.addEventListener("submit", e=>{
        e.preventDefault();

        const id = document.getElementById("cliente-id").value || crypto.randomUUID();

        const cliente = {
          id,
          nombre: document.getElementById("nombre").value.trim(),
          telefono: document.getElementById("telefono").value.trim(),
          direccion: document.getElementById("direccion").value.trim(),
          plan: document.getElementById("plan").value.trim(),
          monto: Number(document.getElementById("monto").value)||null,
          diaPago: Number(document.getElementById("dia-pago").value)||null,
          corteDias: Number(document.getElementById("corte-dias").value)||null,
          notas: document.getElementById("notas").value.trim(),
          historialPagos: {}
        };

        let clientes = cargarClientes();
        const idx = clientes.findIndex(c=>c.id===id);

        if (idx!==-1) {
          cliente.historialPagos = clientes[idx].historialPagos;
          clientes[idx] = cliente;
        } else {
          clientes.push(cliente);
        }

        guardarClientes(clientes);
        e.target.reset();
        document.getElementById("cliente-id").value="";
        renderTablaClientes();
      });
    }

    const buscador = document.getElementById("buscador");
    if (buscador) {
      buscador.addEventListener("input", function(){
        renderTablaClientes(this.value);
      });
    }

    const selectReporte = document.getElementById("reporte-anio");
    if (selectReporte) {
      selectReporte.addEventListener("change", function(){
        renderReporteAnual();
      });
    }

    /* BORRAR */
    function borrarCliente(id) {
      if (!confirm("¬øEliminar cliente?")) return;
      let clientes = cargarClientes().filter(c=>c.id!==id);
      guardarClientes(clientes);
      renderTablaClientes();
    }

    /* ========= MODAL MULTIANUAL ========= */
    let clienteEditandoMeses = null;
    let bufferHistorial = {};

    function abrirModalMeses(id) {
      const clientes = cargarClientes();
      const c = clientes.find(x => x.id === id);
      if (!c) return;

      const esOtroCliente = clienteEditandoMeses !== id;
      const bufferVacio = !bufferHistorial || Object.keys(bufferHistorial).length === 0;

      if (esOtroCliente || bufferVacio) {
        bufferHistorial = JSON.parse(JSON.stringify(c.historialPagos || {}));
      }

      clienteEditandoMeses = id;

      document.getElementById("modal-nombre").textContent = c.nombre;

      const a√±oActual = new Date().getFullYear();
      const selA√±o = document.getElementById("modal-anio");

      if (selA√±o.innerHTML.trim() === "") {
        for (let a = a√±oActual - 5; a <= a√±oActual + 5; a++) {
          const op = document.createElement("option");
          op.value = a;
          op.textContent = a;
          if (a === a√±oActual) op.selected = true;
          selA√±o.appendChild(op);
        }
      }

      const a√±oSeleccionado = Number(selA√±o.value);
      const cont = document.getElementById("lista-meses");
      cont.innerHTML = "";

      const MESES = [
        "Enero","Febrero","Marzo","Abril","Mayo","Junio",
        "Julio","Agosto","Septiembre","Octubre","Noviembre","Diciembre"
      ];

      MESES.forEach((mes, i) => {
        const mesNum = String(i + 1).padStart(2, "0");
        const key = `${a√±oSeleccionado}-${mesNum}`;

        const pagadoActual = bufferHistorial[key] === true;

        const fila = document.createElement("div");
        fila.style = `
          display:flex;
          justify-content:space-between;
          margin:6px 0;
          padding:6px;
          background:#0f172a;
          border-radius:8px;
        `;

        const label = document.createElement("span");
        label.textContent = mes;

        const btn = document.createElement("button");
        btn.className = "btn btn-sm " + (pagadoActual ? "btn-primary" : "btn-danger");
        btn.textContent = pagadoActual ? "‚úî Pagado" : "‚úñ Pendiente";

        btn.onclick = () => {
          bufferHistorial[key] = !pagadoActual;
          abrirModalMeses(id);
        };

        fila.appendChild(label);
        fila.appendChild(btn);
        cont.appendChild(fila);
      });

      document.getElementById("modal-meses").style.display = "flex";
    }

    function cerrarModalMeses() {
      clienteEditandoMeses = null;
      bufferHistorial = {};
      const modal = document.getElementById("modal-meses");
      if (modal) {
        modal.style.display = "none";
      }
    }

    function guardarCambiosHistorial() {
      let clientes = cargarClientes();
      const idx = clientes.findIndex(c => c.id === clienteEditandoMeses);

      if (idx === -1) {
        cerrarModalMeses();
        return;
      }

      clientes[idx].historialPagos = bufferHistorial;

      guardarClientes(clientes);

      cerrarModalMeses();

      const filtro = document.getElementById("buscador")
        ? document.getElementById("buscador").value
        : "";
      renderTablaClientes(filtro);
      renderReporteAnual();
    }

    // Inicializar tabla en cuanto cargue DOM
    renderTablaClientes();

    // ====== Service Worker PWA ======
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker
          .register('./service-worker.js')
          .catch(err => console.error('SW error', err));
      });
    }
  </script>
</body>
</html>
